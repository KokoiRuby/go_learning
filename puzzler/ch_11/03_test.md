Go 语言中自带轻量级的测试框架 testing 和自带的 `go test` 命令来实现单元测试和基准测试。

**单元测试**：软件中的**最小可测试单元**（通常是函数或方法）进行测试的过程。

- 目的：尽早及时发现并修复代码中出现的错误，确保代码变动不会引入新的错误（回归测试）。
- 方法名 `Test*` 前缀，参数列表接收 `*testing.T`

**功能测试**：用于验证软件系统的功能是否按需求文档要求和预期工作。

**模糊测试**：通过向程序提供大量随机或半随机的数据来发现潜在的漏洞、崩溃或异常行为。比如输入边界问题。

**基准测试**：通常用于**衡量**函数或代码块的执行效率。确保在稳定的环境下避免外部干扰保证准确性。

- 方法名 `Benchmark*` 前缀，参数列表接收 `*testing.B`。

**Naming Convention**

1. 测试用例文件必须以 `_test` 结尾
2. 功能测试用例方法必须 `Test` 开头
3. 模糊测试用例方法必须 `Fuzz` 开头
4. 基准测试用例方法必须 `Benchmark` 开头
5. 文件夹`_test` 结尾的测试包，会被编译成分离包

#### go test

`go test` 会编译所有 `*_test.go` 文件的包。以 `_` 和 `.` 开头的文件都会被忽略。

`go test` 前会运行 `go vet` 测试文件签名问题，如果在 `go vert` 过程中发现问题，将停止运行。

```bash
$ go test
$ go test -v
$ go test ./mypackage
```

Flags

- `-benchtime t`：指定测试时间，比如 1s 指定运行 1s
- `-count n` : 指定运行多少次用例。如果 `-cpu` 指定了 cpu 数量，运行次数将会是 `[n * cpu]`
- `-cover`：输出代码测试覆盖率
- `-json` ：以json方式输出测试报告
- `-failfast` ：一个测试用例失败后不去测试其他的测试用例
- `-run regexp`：指定运行测试的规则
- `-cpu 1,2,4`：指定 cpu 数量，会基于一个 cpu 跑一起，基于 2 个 cpu 跑一次，基于 4 个跑一次。对于benchmarks和模糊测试有意义。

**go test 主要流程**

1. 准备：检查 `*_test.go` 文件中是否包含测试函数。
2. 编译：生成临时 bin 文件；如果有 dep，也会一同编译。
3. 运行测试函数：如果有 `t.Parallel()` 则会并行执行。
4. 收集测试函数中的断言结果。
5. 生成测试报告。
6. 后处理，删除临时 bin 文件。

```bash
# unit
$ go test
$ go test -v
$ go test -v ./mypackage
$ go test -cover
$ go test -v > result.log

# bench
# -bench=. run all bench tests
# -run=^$  bench only
$ go test -bench=. -run=^$ ./mypackage
```

`*testing.T` 是单元测试中的**结构体**，每个函数都可以接收一个参数，用于记录结果和报告失败。

- **`t.Error(args ...interface{})`**: 记录一个错误信息，但**不会停止测试**。会继续执行其他的测试代码。

- **`t.Errorf(format string, args ...interface{})`**: 记录格式化的错误信息，并继续执行测试。

- **`t.Fail()`**: 标记测试为失败，但**不会停止测试**。测试会继续执行。

- **`t.FailNow()`**: 标记测试为失败，并停止执行当前测试函数。

- **`t.Fatal(args ...interface{})`**: 标记测试为失败，并停止执行当前测试函数。`t.Fatalf` 可以格式化输出信息。

- **`t.Skip(args ...interface{})`**: 跳过当前测试，记录跳过的原因。`t.Skipf` 可以格式化输出信息。

- **`t.Helper()`**: 将调用该方法的函数标记为测试帮助函数，这样它的调用栈信息会被隐藏在测试结果中，方便定位问题。

- **`t.Log`**：记录一条日志信息。

- **`t.Logf`**：记录一条**格式化**日志信息。

`*testing.B` 是基准测试中的**结构体**，用于运行代码的多次迭代，并记录每次迭代所需的时间。

- **`b.N`**: 记录基准测试的迭代次数。`b.N` 是测试框架决定的，用于执行被测试的代码多次以获得稳定的性能测量。
- **`b.ResetTimer()`**: 重置计时器，并从此时开始计算性能。
- **`b.StopTimer()`**: 在基准测试中，有时需要停止计时器，以便进行一些测试前的准备工作，然后再继续计时。
- **`b.StartTimer()`**: 开启计时器。

**单元测试结果**

是否执行成功，（测试包的路径），耗时。

如果测试代码没有发生变动，则直接返回**缓存** cache 结果；缓存路径：`go env GOCACHE`

清理构建 build 缓存：`go clean -cache`

清理测试 test  缓存：`go clean -testcache`

对于失败的测试结果，不会缓存

**基准测试结果**

操作系统，架构，pkg，maxP，迭代执行测试，平均耗时，成功与否，耗时。

